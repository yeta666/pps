<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yeta.pps.mapper.MyClientMapper" >

    <!--客户登陆-->

    <select id="findByUsernameAndPassword" parameterType="com.yeta.pps.vo.ClientVo" resultType="com.yeta.pps.po.Client">
        select id, name, username, password, phone, level_id, birthday, inviter_id, address, postcode, membership_number, last_deal_time, create_time, disabled, remark from client where username = #{username} and password = #{password};
    </select>

    <!--会员卡号-->

    <insert id="addMembershipNumber" parameterType="com.yeta.pps.po.MembershipNumber" useGeneratedKeys="true" keyProperty="id">
        insert into membership_number (number, disabled) values (#{number}, #{disabled});
    </insert>

    <delete id="deleteMembershipNumber" parameterType="com.yeta.pps.po.MembershipNumber">
        delete from membership_number where id = #{id};
    </delete>

    <update id="updateMembershipNumber" parameterType="com.yeta.pps.po.MembershipNumber">
        update membership_number set number = #{number}, disabled = #{disabled} where id = #{id};
    </update>

    <select id="findCountMembershipNumber" parameterType="com.yeta.pps.po.MembershipNumber" resultType="java.lang.Integer">
        select
            count(0)
        from
            membership_number
        where
            1 = 1
        <if test="number != null">
        and
            number like concat('%', #{number}, '%')
        </if>
        <if test="disabled != null">
        and
            disabled = #{disabled}
        </if>
    </select>

    <select id="findAllPagedMembershipNumber" resultType="com.yeta.pps.po.MembershipNumber">
        select
            id, number, disabled
        from
            membership_number
        where
            1 = 1
        <if test="membershipNumber.number != null">
        and
            number like concat('%', #{membershipNumber.number}, '%')
        </if>
        <if test="membershipNumber.disabled != null">
        and
            disabled = #{membershipNumber.disabled}
        </if>
        limit
            #{pageVo.start}, #{pageVo.pageSize};
    </select>

    <select id="findUsedMembershipNumber" resultType="com.yeta.pps.po.MembershipNumber">
        select
            mn.id, mn.number, mn.disabled
        from
            membership_number as mn,
            client as c
        where
            mn.number = c.membership_number;
    </select>

    <select id="findMembershipNumberByNumber" parameterType="com.yeta.pps.po.MembershipNumber" resultType="com.yeta.pps.po.MembershipNumber">
        select id, number, disabled from membership_number where number = #{number} and disabled = 0;
    </select>

    <!--客户级别-->

    <insert id="addClientLevel" parameterType="com.yeta.pps.po.ClientLevel" useGeneratedKeys="true" keyProperty="id">
        insert into client_level (name, price_type, price) values (#{name}, #{priceType}, #{price});
    </insert>

    <delete id="deleteClientLevel" parameterType="com.yeta.pps.po.ClientLevel">
        delete from client_level where id = #{id};
    </delete>

    <update id="updateClientLevel" parameterType="com.yeta.pps.po.ClientLevel">
        update client_level set name = #{name}, price_type = #{priceType}, price = #{price} where id = #{id};
    </update>

    <select id="findCountClientLevel" resultType="java.lang.Integer">
        select count(0) from client_level;
    </select>

    <select id="findAllPagedClientLevel" parameterType="com.yeta.pps.vo.PageVo" resultType="com.yeta.pps.po.ClientLevel">
        select id, name, price_type, price from client_level limit #{start}, #{pageSize};
    </select>

    <select id="findAllClientLevel" resultType="com.yeta.pps.po.ClientLevel">
        select id, name, price_type, price from client_level;
    </select>

    <select id="findUsedClientLevel" resultType="com.yeta.pps.po.ClientLevel">
        select
            cl.id, cl.name, cl.price_type, cl.price
        from
            client_level as cl,
            client as c
        where
            cl.id = c.level_id;
    </select>

    <select id="findClientLevelByIdOrName" parameterType="com.yeta.pps.po.ClientLevel" resultType="com.yeta.pps.po.ClientLevel">
         select id, name, price_type, price from client_level where 1 = 1
         <if test="id != null">
             and  id = #{id}
         </if>
        <if test="name != null">
            and  name = #{name}
        </if>
    </select>

    <!--客户-->

    <insert id="add" parameterType="com.yeta.pps.vo.ClientVo">
        insert into
          client (id, name, username, password, phone, level_id, birthday, inviter_id, address, postcode, membership_number, last_deal_time, create_time, disabled, remark)
        values
          (#{id}, #{name}, #{username}, #{password}, #{phone}, #{levelId}, #{birthday}, #{inviterId}, #{address}, #{postcode}, #{membershipNumber}, #{lastDealTime}, #{createTime}, #{disabled}, #{remark});
    </insert>

    <delete id="delete" parameterType="com.yeta.pps.vo.ClientVo">
        delete from client where id = #{id} and level_id > 0;
    </delete>

    <update id="update" parameterType="com.yeta.pps.vo.ClientVo">
        update client set name = #{name}, password = #{password}, phone = #{phone}, birthday = #{birthday}, address = #{address}, postcode = #{postcode} where id = #{id};
    </update>

    <update id="updateDisabledAndRemark" parameterType="com.yeta.pps.vo.ClientVo">
        update client set disabled = #{disabled}, remark = #{remark} where id = #{id} and level_id > 0;
    </update>

    <update id="updateLastDealTime" parameterType="com.yeta.pps.vo.ClientVo">
        update client set last_deal_time = now() where id = #{id} and level_id > 0;
    </update>

    <select id="findCount" parameterType="com.yeta.pps.vo.ClientVo" resultType="java.lang.Integer">
        select
            count(0)
        from
            client as c
        left join client_level as cl on c.level_id = cl.id
        where
            c.level_id > 0
        <if test="id != null">
        and
            c.id = #{id}
        </if>
        <if test="name != null">
        and
            c.name like concat('%', #{name}, '%')
        </if>
        <if test="phone != null">
        and
            c.phone like concat('%', #{phone}, '%')
        </if>
        <if test="membershipNumber != null">
        and
            c.membership_number like concat('%', #{membershipNumber}, '%')
        </if>
        <if test="levelId != null">
        and
            c.level_id = #{levelId}
        </if>
        <if test="disabled != null">
        and
            c.disabled = #{disabled}
        </if>
    </select>

    <resultMap id="clientVoMap" type="com.yeta.pps.vo.ClientVo">
        <id column="id" property="id" />
        <result column="name" property="name" />
        <result column="username" property="username" />
        <result column="password" property="password" />
        <result column="phone" property="phone" />
        <result column="level_id" property="levelId" />
        <result column="birthday" property="birthday" />
        <result column="inviter_id" property="inviterId" />
        <result column="address" property="address" />
        <result column="postcode" property="postcode" />
        <result column="membership_number" property="membershipNumber" />
        <result column="last_deal_time" property="lastDealTime" />
        <result column="create_time" property="createTime" />
        <result column="disabled" property="disabled" />
        <result column="remark" property="remark" />
        <collection property="clientLevel" ofType="com.yeta.pps.po.ClientLevel">
            <id column="cl_id" property="id" />
            <result column="cl_name" property="name" />
            <result column="cl_price_type" property="priceType" />
            <result column="cl_price" property="price" />
        </collection>
    </resultMap>

    <select id="findAllPaged" resultMap="clientVoMap">
        select
            c.id,
            c.name,
            c.username,
            c.password,
            c.phone,
            c.level_id,
            c.birthday,
            c.inviter_id,
            c.address,
            c.postcode,
            c.membership_number,
            c.last_deal_time,
            c.create_time,
            c.disabled,
            c.remark,
            cl.id as cl_id,
            cl.name as cl_name,
            cl.price_type as cl_price_type,
            cl.price as cl_price
        from
            client as c
        left join client_level as cl on c.level_id = cl.id
        where
            c.level_id > 0
        <if test="clientVo.id != null">
        and
            c.id = #{clientVo.id}
        </if>
        <if test="clientVo.name != null">
        and
            c.name like concat('%', #{clientVo.name}, '%')
        </if>
        <if test="clientVo.phone != null">
        and
            c.phone like concat('%', #{clientVo.phone}, '%')
        </if>
        <if test="clientVo.membershipNumber != null">
        and
            c.membership_number like concat('%', #{clientVo.membershipNumber}, '%')
        </if>
        <if test="clientVo.levelId != null">
        and
            c.level_id = #{clientVo.levelId}
        </if>
        <if test="clientVo.disabled != null">
        and
            c.disabled = #{clientVo.disabled}
        </if>
        limit
            #{pageVo.start}, #{pageVo.pageSize};
    </select>

    <select id="findAll" parameterType="com.yeta.pps.vo.ClientVo" resultMap="clientVoMap">
        select
            c.id,
            c.name,
            c.username,
            c.password,
            c.phone,
            c.level_id,
            c.birthday,
            c.inviter_id,
            c.address,
            c.postcode,
            c.membership_number,
            c.last_deal_time,
            c.create_time,
            c.disabled,
            c.remark,
            cl.id as cl_id,
            cl.name as cl_name,
            cl.price_type as cl_price_type,
            cl.price as cl_price
        from
            client as c
        left join client_level as cl on c.level_id = cl.id
        where
            c.level_id > 0
        <if test="id != null">
        and
            c.id = #{id}
        </if>
        <if test="name != null">
        and
            c.name like concat('%', #{name}, '%')
        </if>
        <if test="phone != null">
        and
            c.phone like concat('%', #{phone}, '%')
        </if>
        <if test="membershipNumber != null">
        and
            c.membership_number like concat('%', #{membershipNumber}, '%')
        </if>
        <if test="levelId != null">
        and
            c.level_id = #{levelId}
        </if>
        <if test="disabled != null">
            and
            c.disabled = #{disabled}
        </if>
    </select>

    <select id="findByIdOrPhone" parameterType="com.yeta.pps.vo.ClientVo" resultType="com.yeta.pps.po.Client">
        select id, name, username, password, phone, level_id, birthday, inviter_id, address, postcode, membership_number, last_deal_time, create_time, disabled, remark from client where 1 = 1
        <if test="id != null">
            and id = #{id}
        </if>
        <if test="phone != null">
            and phone = #{phone}
        </if>
    </select>

    <!--店铺/积分、预收款关系-->

    <insert id="addStoreIntegral" parameterType="com.yeta.pps.vo.StoreIntegralVo">
        insert into store_integral (store_id, client_id, integral, advance_money) values (#{storeId}, #{clientId}, #{integral}, #{advanceMoney});
    </insert>
        
    <delete id="deleteStoreIntegralByClientId" parameterType="com.yeta.pps.vo.StoreIntegralVo">
        delete from store_integral where client_id = #{clientId};
    </delete>

    <update id="increaseIntegral" parameterType="com.yeta.pps.vo.StoreIntegralVo">
        update store_integral set integral = integral + #{integral} where store_id = #{storeId} and client_id = #{clientId};
    </update>

    <update id="decreaseIntegral" parameterType="com.yeta.pps.vo.StoreIntegralVo">
        update store_integral set integral = integral - #{integral} where store_id = #{storeId} and client_id = #{clientId} and integral - #{integral} &gt;= 0;
    </update>
    
    <update id="updateAdvanceMoney" parameterType="com.yeta.pps.vo.StoreIntegralVo">
        update store_integral set advance_money = advance_money + #{advanceMoney} where store_id = #{storeId} and client_id = #{clientId} and advance_money + #{advanceMoney} &gt;= 0;
    </update>
    
    <select id="findCountStoreIntegral" parameterType="com.yeta.pps.vo.StoreIntegralVo" resultType="java.lang.Integer">
        select
            count(0)
        from
            (
                (
                    store_integral as si
                    left join store as s on si.store_id = s.id
                )
                left join client as c on si.client_id = c.id
            )
        left join client_level as cl on c.level_id = cl.id
        where
            1 = 1
        <if test="storeId != null">
            and si.store_id = #{storeId}
        </if>
        <if test="clientId != null">
            and si.client_id = #{clientId}
        </if>
    </select>

    <resultMap id="storeIntegralMap" type="com.yeta.pps.vo.StoreIntegralVo">
        <id column="id" property="id" />
        <result column="store_id" property="storeId" />
        <result column="client_id" property="clientId" />
        <result column="integral" property="integral" />
        <result column="advance_money" property="advanceMoney" />
        <collection property="store" ofType="com.yeta.pps.po.Store">
            <id column="s_id" property="id" />
            <result column="s_name" property="name" />
            <result column="s_address" property="address" />
        </collection>
        <collection property="clientVo" ofType="com.yeta.pps.vo.ClientVo">
            <id column="c_id" property="id" />
            <result column="c_name" property="name" />
            <result column="c_username" property="username" />
            <result column="c_password" property="password" />
            <result column="c_phone" property="phone" />
            <result column="c_level_id" property="levelId" />
            <result column="c_birthday" property="birthday" />
            <result column="c_inviter_id" property="inviterId" />
            <result column="c_address" property="address" />
            <result column="c_postcode" property="postcode" />
            <result column="c_membership_number" property="membershipNumber" />
            <result column="c_last_deal_time" property="lastDealTime" />
            <result column="c_create_time" property="createTime" />
            <result column="c_disabled" property="disabled" />
            <result column="c_remark" property="remark" />
            <collection property="clientLevel" ofType="com.yeta.pps.po.ClientLevel">
                <id column="cl_id" property="id" />
                <result column="cl_name" property="name" />
                <result column="cl_price_type" property="priceType" />
                <result column="cl_price" property="price" />
            </collection>
        </collection>
    </resultMap>

    <select id="findAllPagedStoreIntegral" resultMap="storeIntegralMap">
        select 
            si.id,
            si.store_id,
            si.client_id,
            si.integral,
            si.advance_money,
            s.id as s_id,
            s.name as s_name,
            s.address as s_address,
            c.id as c_id,
            c.name as c_name,
            c.username as c_username,
            c.password as c_password,
            c.phone as c_phone,
            c.level_id as c_level_id,
            c.birthday as c_birthday,
            c.inviter_id as c_inviter_id,
            c.address as c_address,
            c.postcode as c_postcode,
            c.membership_number as c_membership_number,
            c.last_deal_time as c_last_deal_time,
            c.create_time as c_create_time,
            c.disabled as c_disabled,
            c.remark as c_remark,
            cl.id as cl_id,
            cl.name as cl_name,
            cl.price_type as cl_price_type,
            cl.price as cl_price
        from 
            (
                (
                    store_integral as si
                    left join store as s on si.store_id = s.id
                )
                left join client as c on si.client_id = c.id
            )
        left join client_level as cl on c.level_id = cl.id
        where
            1 = 1
        <if test="storeIntegralVo.storeId != null">
            and si.store_id = #{storeIntegralVo.storeId}
        </if>
        <if test="storeIntegralVo.clientId != null">
            and si.client_id = #{storeIntegralVo.clientId}
        </if>
        limit
            #{pageVo.start}, #{pageVo.pageSize};
    </select>

    <select id="findStoreIntegralByStoreIdAndClientId" parameterType="com.yeta.pps.vo.StoreIntegralVo" resultType="com.yeta.pps.vo.StoreIntegralVo">
        select id, store_id, client_id, integral, advance_money from store_integral where store_id = #{storeId} and client_id = #{clientId};
    </select>

    <!--客户/积分明细关系-->

    <insert id="addIntegralDetail" parameterType="com.yeta.pps.vo.ClientIntegralDetailVo">
        insert into client_integral_detail
            (store_id, client_id, create_time, type, change_integral, after_change_integral, order_id)
        values
            (#{storeId}, #{clientId}, #{createTime}, #{type}, #{changeIntegral}, #{afterChangeIntegral}, #{orderId});
    </insert>

    <delete id="deleteIntegralDetailByClientId" parameterType="com.yeta.pps.vo.ClientIntegralDetailVo">
        delete from client_integral_detail where client_id = #{clientId};
    </delete>

    <select id="findCountIntegralDetail" parameterType="com.yeta.pps.vo.ClientIntegralDetailVo" resultType="java.lang.Integer">
        select
            count(0)
        from
            (
                (
                    client_integral_detail as cid
                    left join store as s on cid.store_id = s.id
                )
            left join client as c on cid.client_id = c.id
            )
        left join client_level as cl on c.level_id = cl.id
        where
            1 = 1
        <if test="storeId != null">
            and store_id = #{storeId}
        </if>
        <if test="clientId != null">
            and client_id = #{clientId}
        </if>
        <if test="type != null">
            and type = #{type}
        </if>
        order by
            cid.create_time desc;
    </select>

    <resultMap id="clientIntegralDetailVoMap" type="com.yeta.pps.vo.ClientIntegralDetailVo">
        <id column="id" property="id" />
        <result column="store_id" property="storeId" />
        <result column="client_id" property="clientId" />
        <result column="create_time" property="createTime" />
        <result column="type" property="type" />
        <result column="change_integral" property="changeIntegral" />
        <result column="after_change_integral" property="afterChangeIntegral" />
        <result column="order_id" property="orderId" />
        <collection property="store" ofType="com.yeta.pps.po.Store">
            <id column="s_id" property="id" />
            <result column="s_name" property="name" />
            <result column="s_address" property="address" />
        </collection>
        <collection property="clientVo" ofType="com.yeta.pps.vo.ClientVo">
            <id column="c_id" property="id" />
            <result column="c_name" property="name" />
            <result column="c_username" property="username" />
            <result column="c_password" property="password" />
            <result column="c_phone" property="phone" />
            <result column="c_level_id" property="levelId" />
            <result column="c_birthday" property="birthday" />
            <result column="c_inviter_id" property="inviterId" />
            <result column="c_address" property="address" />
            <result column="c_postcode" property="postcode" />
            <result column="c_membership_number" property="membershipNumber" />
            <result column="c_last_deal_time" property="lastDealTime" />
            <result column="c_create_time" property="createTime" />
            <result column="c_disabled" property="disabled" />
            <result column="c_remark" property="remark" />
            <collection property="clientLevel" ofType="com.yeta.pps.po.ClientLevel">
                <id column="cl_id" property="id" />
                <result column="cl_name" property="name" />
                <result column="cl_price_type" property="priceType" />
                <result column="cl_price" property="price" />
            </collection>
        </collection>
    </resultMap>

    <select id="findAllPagedIntegralDetail" resultMap="clientIntegralDetailVoMap">
        select
            cid.id,
            cid.store_id,
            cid.client_id,
            cid.create_time,
            cid.type,
            cid.change_integral,
            cid.after_change_integral,
            cid.order_id,
            s.id as s_id,
            s.name as s_name,
            s.address as s_address,
            c.id as c_id,
            c.name as c_name,
            c.username as c_username,
            c.password as c_password,
            c.phone as c_phone,
            c.level_id as c_level_id,
            c.birthday as c_birthday,
            c.inviter_id as c_inviter_id,
            c.address as c_address,
            c.postcode as c_postcode,
            c.membership_number as c_membership_number,
            c.last_deal_time as c_last_deal_time,
            c.create_time as c_create_time,
            c.disabled as c_disabled,
            c.remark as c_remark,
            cl.id as cl_id,
            cl.name as cl_name,
            cl.price_type as cl_price_type,
            cl.price as cl_price
        from
            (
                (
                    client_integral_detail as cid
                    left join store as s on cid.store_id = s.id
                )
                left join client as c on cid.client_id = c.id
            )
        left join client_level as cl on c.level_id = cl.id
        where
            1 = 1
        <if test="clientIntegralDetailVo.storeId != null">
            and store_id = #{clientIntegralDetailVo.storeId}
        </if>
        <if test="clientIntegralDetailVo.clientId != null">
            and client_id = #{clientIntegralDetailVo.clientId}
        </if>
        <if test="clientIntegralDetailVo.type != null">
            and type = #{clientIntegralDetailVo.type}
        </if>
        order by
            cid.create_time desc
        limit
            #{pageVo.start}, #{pageVo.pageSize};
    </select>

</mapper>